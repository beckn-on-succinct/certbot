{
    "name": "extract_logs",
    "steps": [
        {
            "name" : "extractlogs",
            "request" : {
                "method" : "get",
                "url":"https://${context.bpp_id}/messages/search?q=TRANSACTION_ID%3A%22${confirm.request.body.context.transaction_id}%22+AND+APPLICATION_NETWORK_ID%3A56",
                "headers": {
                    "Content-Type" : "application/json",
                    "X-ApiKey" : "${bpp.x_api_key}"
                }
            },
            "request_finalizer" : ["var Util = Java.type('in.humbhionline.certbot.exports.Util');",
                                    "Util.sleep(30000);",
                                    "imf = {\"Message\":[\"Id\",\"MessageId\",\"Payload\",\"Direction\",\"CreatedAt\"] }",
                                     "request.headers.IncludedModelFields = Util.btoa(JSON.stringify(imf))"],
            "logs": [],
            "logs_finalizer" : [
                "var r = extractlogs.response;",
                "var messages = r.data.Messages.sort(function(m1,m2){ return m1.Id - m2.Id});",
                "messages.forEach(function(m) { ",
                "                   if (m.Direction.endsWith('Network')){ ",
                "                       m.Payload = JSON.parse(m.Payload); ", 
                "                       var name = m.Payload.context.action ;",
                "                       if (m.Direction.startsWith('To')){ ",
                "                           name = name + '-' + m.Payload.message.order.state ;",
                "                           name = name + (m.Payload.message.order.fulfillments[0].state ? '-' + m.Payload.message.order.fulfillments[0].state.descriptor.code : '-undefined' ); " , 
                "                       }",
                "                       logs.push({\"name\": name, \"value\": JSON.stringify(m.Payload)});",
                "                       r[name] = m.Payload;",
                "                   }",
                "})"
            ]

        },
        {
            "name": "ondc_validator",
            "request": {
                "headers": {
                    "Content-Type": "application/json"
                },
                "body": {
                    "domain": "${context.domain}",
                    "version": "${context.core_version}"
                },
                "method": "post",
                "timeout": 60,
                "url": "https://log-validation.ondc.org/api/validate"
            },
            "request_finalizer": [ "request.body.payload = {\"search_full_catalog_refresh\" : search.request.body,",
                                                            "\"on_search_full_catalog_refresh\"  : search.response.data[0],",
                                                            "\"select\"  : select.request.body,",
                                                            "\"on_select\"  : select.response.data,",
                                                            "\"init\"  : init.request.body,",
                                                            "\"on_init\"  : init.response.data,",
                                                            "\"confirm\"  : confirm.request.body,",
                                                            "\"on_confirm\"  : confirm.response.data,",
                                                            "\"on_status_pending\"  : extractlogs.response['on_status-In-progress-Packed'],",
                                                            "\"on_status_picked\"  : extractlogs.response['on_status-In-progress-Order-picked-up'],",
                                                            "\"on_status_delivered\"  : extractlogs.response['on_status-Completed-Order-delivered'],",
                                                            "}"],
            "assertion": {
                "script": {
                    "eval": "ondc_validator.response.status == 200"
                }
            },
            "logs": [
                {
                    "name": "ondcvalidator.log",
                    "value": "${JSON.stringify(ondc_validator.response)}"
                },
                {
                    "name": "ondcvalidator_payload.json",
                    "value": "${JSON.stringify(ondc_validator.request.body)}"
                }
            ]
        }
    ]
}
